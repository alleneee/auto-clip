# Auto-Clip è§†é¢‘å¤„ç†é“¾è·¯å®Œæ•´æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒå¤„ç†æµç¨‹](#æ ¸å¿ƒå¤„ç†æµç¨‹)
3. [è¯¦ç»†æŠ€æœ¯æµç¨‹](#è¯¦ç»†æŠ€æœ¯æµç¨‹)
4. [æœåŠ¡æ¨¡å—è¯´æ˜](#æœåŠ¡æ¨¡å—è¯´æ˜)
5. [æ•°æ®æµè½¬](#æ•°æ®æµè½¬)
6. [é”™è¯¯å¤„ç†ä¸é‡è¯•](#é”™è¯¯å¤„ç†ä¸é‡è¯•)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API å±‚ (FastAPI)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ /batch/      â”‚  â”‚ /videos/     â”‚  â”‚ /tasks/      â”‚      â”‚
â”‚  â”‚ process      â”‚  â”‚ endpoints    â”‚  â”‚ status       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¼‚æ­¥ä»»åŠ¡å±‚ (Celery + Redis)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Worker Queues:                                      â”‚   â”‚
â”‚  â”‚  â€¢ analyzer (VLåˆ†æä»»åŠ¡)                             â”‚   â”‚
â”‚  â”‚  â€¢ clipper (è§†é¢‘å‰ªè¾‘ä»»åŠ¡)                            â”‚   â”‚
â”‚  â”‚  â€¢ default (é€šç”¨ä»»åŠ¡)                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å±‚ (Business Logic)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ è§†é¢‘åˆ†æ     â”‚  â”‚ è§†é¢‘ç¼–è¾‘     â”‚  â”‚ å†…å®¹ç”Ÿæˆ     â”‚      â”‚
â”‚  â”‚ å‹ç¼©å­˜å‚¨     â”‚  â”‚ éŸ³é¢‘å¤„ç†     â”‚  â”‚ AIæ¨ç†       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åŸºç¡€è®¾æ–½å±‚                                  â”‚
â”‚  â€¢ DashScope AI (è§†è§‰/æ–‡æœ¬/è¯­éŸ³)                             â”‚
â”‚  â€¢ MoviePy 2.x (è§†é¢‘å¤„ç†)                                    â”‚
â”‚  â€¢ Redis (æ¶ˆæ¯é˜Ÿåˆ—/ç¼“å­˜)                                     â”‚
â”‚  â€¢ OSS/æœ¬åœ°å­˜å‚¨ (æ–‡ä»¶å­˜å‚¨)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒå¤„ç†æµç¨‹

### æµç¨‹ 1: å¤šè§†é¢‘æ‰¹å¤„ç†æµç¨‹ (æ ¸å¿ƒ)

**å…¥å£**: `POST /api/v1/batch/process`

```
ç”¨æˆ·è¯·æ±‚
   â†“
[APIæ¥æ”¶] batch.py::create_batch_process()
   â†“
[åˆ›å»ºCeleryä»»åŠ¡] batch_process_videos_task
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Celery Chord ç¼–æ’ (å¹¶è¡Œâ†’èšåˆ)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  é˜¶æ®µ1: å‡†å¤‡è§†é¢‘ (å¹¶è¡Œ)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ è§†é¢‘1 â†’ prepare_video_task               â”‚      â”‚
â”‚  â”‚ è§†é¢‘2 â†’ prepare_video_task               â”‚      â”‚
â”‚  â”‚ è§†é¢‘N â†’ prepare_video_task               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â†“ (éªŒè¯/ä¸‹è½½)                            â”‚
â”‚                                                     â”‚
â”‚  é˜¶æ®µ2: å‹ç¼©ä¸Šä¼  (å¹¶è¡Œ)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ è§†é¢‘1 â†’ compress_and_upload_task         â”‚      â”‚
â”‚  â”‚ è§†é¢‘2 â†’ compress_and_upload_task         â”‚      â”‚
â”‚  â”‚ è§†é¢‘N â†’ compress_and_upload_task         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â†“ (å‹ç¼©+OSSä¸Šä¼ )                         â”‚
â”‚                                                     â”‚
â”‚  é˜¶æ®µ3: AIåˆ†æ (å¹¶è¡Œ)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ è§†é¢‘1 â†’ analyze_video_task               â”‚      â”‚
â”‚  â”‚ è§†é¢‘2 â†’ analyze_video_task               â”‚      â”‚
â”‚  â”‚ è§†é¢‘N â†’ analyze_video_task               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â†“ (VLæ¨¡å‹åˆ†æ)                           â”‚
â”‚                                                     â”‚
â”‚  é˜¶æ®µ4: ç”Ÿæˆå‰ªè¾‘æ–¹æ¡ˆ (èšåˆ)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  generate_clip_plan_task                 â”‚      â”‚
â”‚  â”‚  â€¢ èšåˆæ‰€æœ‰åˆ†æç»“æœ                      â”‚      â”‚
â”‚  â”‚  â€¢ LLMç”Ÿæˆå‰ªè¾‘å†³ç­–                       â”‚      â”‚
â”‚  â”‚  â€¢ è´¨é‡è¯„åˆ†                              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â†“ (ClipPlan)                             â”‚
â”‚                                                     â”‚
â”‚  é˜¶æ®µ5: æ‰§è¡Œå‰ªè¾‘ (ä¸²è¡Œ)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  execute_clip_plan_task                  â”‚      â”‚
â”‚  â”‚  â€¢ æå–ç‰‡æ®µ                              â”‚      â”‚
â”‚  â”‚  â€¢ åº”ç”¨è½¬åœº                              â”‚      â”‚
â”‚  â”‚  â€¢ æ‹¼æ¥è§†é¢‘                              â”‚      â”‚
â”‚  â”‚  â€¢ ä¸Šä¼ ç»“æœ                              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â†“                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
[è¿”å›ç»“æœ] æœ€ç»ˆè§†é¢‘URL + ç»Ÿè®¡ä¿¡æ¯
```

**ç‰¹ç‚¹**:
- âœ… å¹¶è¡Œå¤„ç†æœ€å¤§åŒ–æ€§èƒ½
- âœ… ä»»åŠ¡éš”ç¦»ï¼ˆanalyzer/clipperé˜Ÿåˆ—ï¼‰
- âœ… å®Œæ•´é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… è´¨é‡è¯„åˆ†ç³»ç»Ÿ

---

### æµç¨‹ 2: è§†é¢‘ç”Ÿäº§æµç¨‹ (è„šæœ¬â†’TTSâ†’åˆæˆ)

**å…¥å£**: `VideoProductionOrchestrator`

```
è¾“å…¥: ä¸»é¢˜/å¤§çº²
   â†“
[1. è„šæœ¬ç”Ÿæˆ] ScriptGenerationService
   â€¢ AIç”Ÿæˆå®Œæ•´è„šæœ¬
   â€¢ æ®µè½åŒ–å¤„ç†
   â†“
[2. TTSè¯­éŸ³åˆæˆ] (å¹¶è¡Œå¤„ç†æ¯æ®µ)
   â€¢ DashScope TTS
   â€¢ éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆ
   â†“
[3. è§†é¢‘å†…å®¹åŒ¹é…]
   â€¢ åˆ†æç°æœ‰è§†é¢‘ç‰‡æ®µ
   â€¢ åŒ¹é…è„šæœ¬å†…å®¹
   â†“
[4. è§†é¢‘éŸ³é¢‘åˆæˆ] VideoAudioComposer
   â€¢ æ—¶é—´è½´å¯¹é½
   â€¢ éŸ³é¢‘æ··åˆ
   â€¢ å­—å¹•å åŠ ï¼ˆå¯é€‰ï¼‰
   â†“
è¾“å‡º: å¸¦æ—ç™½çš„å®Œæ•´è§†é¢‘
```

**ä½¿ç”¨åœºæ™¯**:
- æ•™å­¦è§†é¢‘åˆ¶ä½œ
- äº§å“ä»‹ç»è§†é¢‘
- æ–°é—»è§£è¯´è§†é¢‘

---

### æµç¨‹ 2.5: å®Œæ•´è§†é¢‘ç”Ÿäº§é›†æˆæµç¨‹ (NEW - æ‰¹å¤„ç†+ç”Ÿäº§ä¸€ä½“åŒ–)

**å…¥å£**: `POST /api/v1/batch/process` (é…ç½® `add_narration: true`)

è¿™æ˜¯**æœ€æ–°å®ç°çš„å®Œæ•´å·¥ä½œæµ**ï¼Œå°†å¤šè§†é¢‘åˆ†æã€å‰ªè¾‘è®¡åˆ’ç”Ÿæˆå’Œè§†é¢‘ç”Ÿäº§æµç¨‹å®Œå…¨æ•´åˆåœ¨ä¸€èµ·ã€‚

```
ç”¨æˆ·è¯·æ±‚ (é…ç½®add_narration=trueæˆ–background_music_path)
   â†“
[APIæ¥æ”¶] batch.py::create_batch_process()
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å®Œæ•´è§†é¢‘ç”Ÿäº§ Celery Workflow                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  é˜¶æ®µ1-3: è§†é¢‘å‡†å¤‡ã€å‹ç¼©ã€AIåˆ†æ (å¹¶è¡Œ)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ åŒæµç¨‹1çš„é˜¶æ®µ1-3                              â”‚         â”‚
â”‚  â”‚ â€¢ prepare_video_task (å¹¶è¡Œ)                   â”‚         â”‚
â”‚  â”‚ â€¢ compress_and_upload_task (å¹¶è¡Œ)             â”‚         â”‚
â”‚  â”‚ â€¢ analyze_video_task (å¹¶è¡Œ)                   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚            â†“                                                â”‚
â”‚  é˜¶æ®µ4: ç”Ÿæˆå‰ªè¾‘æ–¹æ¡ˆ + è§†é¢‘è„šæœ¬ (èšåˆ+LLM)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  generate_clip_plan_task                      â”‚         â”‚
â”‚  â”‚  â€¢ èšåˆæ‰€æœ‰è§†é¢‘åˆ†æç»“æœ                       â”‚         â”‚
â”‚  â”‚  â€¢ LLM Pass 1: æå–ä¸»é¢˜å’Œå…³é”®å†…å®¹             â”‚         â”‚
â”‚  â”‚  â€¢ LLM Pass 2: ç”Ÿæˆå‰ªè¾‘å†³ç­–                   â”‚         â”‚
â”‚  â”‚  â€¢ è´¨é‡è¯„åˆ† (5ç»´åº¦è¯„ä¼°)                       â”‚         â”‚
â”‚  â”‚  â€¢ ä¿å­˜analysis_resultsä¾›åç»­ä½¿ç”¨             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚            â†“ (ClipPlan + analysis_results)                  â”‚
â”‚                                                             â”‚
â”‚  é˜¶æ®µ5: æ‰§è¡Œå‰ªè¾‘è®¡åˆ’ (ä¸²è¡Œ)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  execute_clip_plan_task                       â”‚         â”‚
â”‚  â”‚  â€¢ æå–æ‰€æœ‰è§†é¢‘ç‰‡æ®µ                           â”‚         â”‚
â”‚  â”‚  â€¢ åº”ç”¨è½¬åœºæ•ˆæœ                               â”‚         â”‚
â”‚  â”‚  â€¢ æ‹¼æ¥åˆæˆåŸºç¡€è§†é¢‘                           â”‚         â”‚
â”‚  â”‚  â€¢ ä¸Šä¼ ä¸­é—´ç»“æœ                               â”‚         â”‚
â”‚  â”‚  â€¢ ä¼ é€’video_pathså’Œanalysis_results          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚            â†“ (åŸºç¡€å‰ªè¾‘è§†é¢‘ + åˆ†ææ•°æ®)                      â”‚
â”‚                                                             â”‚
â”‚  é˜¶æ®µ6: å®Œæ•´è§†é¢‘ç”Ÿäº§ (NEW - è„šæœ¬+TTS+åˆæˆ)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  produce_final_video_with_narration_task      â”‚         â”‚
â”‚  â”‚                                               â”‚         â”‚
â”‚  â”‚  [6.1] è„šæœ¬ç”Ÿæˆ                               â”‚         â”‚
â”‚  â”‚  â€¢ åŸºäºanalysis_resultsç”Ÿæˆè§†é¢‘è„šæœ¬           â”‚         â”‚
â”‚  â”‚  â€¢ VideoProductionOrchestrator.produce_video  â”‚         â”‚
â”‚  â”‚  â€¢ LLMç”Ÿæˆå®Œæ•´å£æ’­æ–‡æ¡ˆ                        â”‚         â”‚
â”‚  â”‚  â€¢ æ®µè½åŒ–å¤„ç†                                 â”‚         â”‚
â”‚  â”‚                                               â”‚         â”‚
â”‚  â”‚  [6.2] TTSè¯­éŸ³åˆæˆ (å¹¶è¡Œ)                     â”‚         â”‚
â”‚  â”‚  â€¢ DashScope TTS API                          â”‚         â”‚
â”‚  â”‚  â€¢ æ¯æ®µè„šæœ¬å¹¶è¡Œç”ŸæˆéŸ³é¢‘                       â”‚         â”‚
â”‚  â”‚  â€¢ éŸ³é¢‘æ–‡ä»¶åˆå¹¶                               â”‚         â”‚
â”‚  â”‚                                               â”‚         â”‚
â”‚  â”‚  [6.3] è§†é¢‘å†…å®¹åŒ¹é…                           â”‚         â”‚
â”‚  â”‚  â€¢ å°†è§†é¢‘ç‰‡æ®µä¸è„šæœ¬æ®µè½å¯¹åº”                   â”‚         â”‚
â”‚  â”‚  â€¢ è®¡ç®—æ—¶é—´è½´                                 â”‚         â”‚
â”‚  â”‚                                               â”‚         â”‚
â”‚  â”‚  [6.4] éŸ³è§†é¢‘åˆæˆ                             â”‚         â”‚
â”‚  â”‚  â€¢ VideoAudioComposer.compose                 â”‚         â”‚
â”‚  â”‚  â€¢ è§†é¢‘æ—¶é—´è½´å¯¹é½                             â”‚         â”‚
â”‚  â”‚  â€¢ èƒŒæ™¯éŸ³ä¹æ··åˆ (å¯é€‰)                        â”‚         â”‚
â”‚  â”‚  â€¢ TTSéŸ³è½¨å åŠ                                 â”‚         â”‚
â”‚  â”‚  â€¢ éŸ³é‡å½’ä¸€åŒ–                                 â”‚         â”‚
â”‚  â”‚                                               â”‚         â”‚
â”‚  â”‚  [6.5] è´¨é‡è¯„åˆ†                               â”‚         â”‚
â”‚  â”‚  â€¢ 5ç»´åº¦è¯„åˆ†ç³»ç»Ÿ                              â”‚         â”‚
â”‚  â”‚  â€¢ narrative_coherence (å™äº‹è¿è´¯æ€§)          â”‚         â”‚
â”‚  â”‚  â€¢ audio_video_sync (éŸ³ç”»åŒæ­¥)               â”‚         â”‚
â”‚  â”‚  â€¢ content_coverage (å†…å®¹è¦†ç›–)               â”‚         â”‚
â”‚  â”‚  â€¢ production_quality (åˆ¶ä½œè´¨é‡)             â”‚         â”‚
â”‚  â”‚  â€¢ engagement_potential (å¸å¼•åŠ›)             â”‚         â”‚
â”‚  â”‚                                               â”‚         â”‚
â”‚  â”‚  [6.6] ä¸Šä¼ æœ€ç»ˆç»“æœ                           â”‚         â”‚
â”‚  â”‚  â€¢ ä¸Šä¼ åˆ°OSS/æœ¬åœ°å­˜å‚¨                         â”‚         â”‚
â”‚  â”‚  â€¢ ç”Ÿæˆå…¬å¼€è®¿é—®URL                            â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚            â†“                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
[è¿”å›ç»“æœ] å®Œæ•´è§†é¢‘URL + è„šæœ¬ + è´¨é‡è¯„åˆ† + ç»Ÿè®¡ä¿¡æ¯
```

**å·¥ä½œæµå†³ç­–é€»è¾‘**:
```python
# åœ¨ batch_process_videos_task ä¸­
use_full_production = config.get('add_narration', False) or config.get('background_music_path')

if use_full_production:
    # å®Œæ•´ç”Ÿäº§æµç¨‹ï¼šé˜¶æ®µ1-6å…¨éƒ¨æ‰§è¡Œ
    workflow = chord([...])(
        generate_clip_plan_task.s(...)
        | execute_clip_plan_task.s(...)
        | produce_final_video_with_narration_task.s(video_paths=..., config=...)
    )
else:
    # åŸºç¡€æµç¨‹ï¼šä»…é˜¶æ®µ1-5
    workflow = chord([...])(
        generate_clip_plan_task.s(...)
        | execute_clip_plan_task.s(...)
    )
```

**æ ¸å¿ƒåˆ›æ–°ç‚¹**:
- âœ¨ **å®Œæ•´é—­ç¯**: ä»åŸå§‹è§†é¢‘åˆ°å¸¦å£æ’­çš„æˆå“è§†é¢‘ä¸€æ°”å‘µæˆ
- ğŸ”— **æ•°æ®æµè½¬**: analysis_resultsåœ¨æ•´ä¸ªworkflowä¸­ä¼ é€’
- ğŸ¯ **æ™ºèƒ½ç”Ÿæˆ**: åŸºäºè§†é¢‘å†…å®¹è‡ªåŠ¨ç”ŸæˆåŒ¹é…çš„è„šæœ¬
- ğŸµ **ä¸“ä¸šéŸ³é¢‘**: TTS + èƒŒæ™¯éŸ³ä¹æ··åˆï¼ŒéŸ³é‡è‡ªåŠ¨å¹³è¡¡
- ğŸ“Š **è´¨é‡ä¿è¯**: 5ç»´åº¦è¯„åˆ†ç³»ç»Ÿç¡®ä¿è¾“å‡ºè´¨é‡
- âš™ï¸ **çµæ´»é…ç½®**: é€šè¿‡configæ§åˆ¶æ˜¯å¦å¯ç”¨å®Œæ•´æµç¨‹

**APIè¯·æ±‚ç¤ºä¾‹**:
```json
{
  "video_paths": [
    "/path/to/video1.mp4",
    "/path/to/video2.mp4"
  ],
  "config": {
    "add_narration": true,
    "narration_voice": "longxiaochun",
    "background_music_path": "/path/to/music.mp3",
    "background_music_volume": 0.2,
    "target_duration": 60,
    "min_clip_duration": 2.0,
    "transition_type": "crossfade"
  }
}
```

**è¾“å‡ºç»“æœ**:
```json
{
  "task_id": "batch_xxx",
  "status": "completed",
  "final_video": {
    "url": "https://xxx/final_video_with_narration.mp4",
    "path": "/storage/final_video_with_narration.mp4",
    "duration": 62.5
  },
  "script": {
    "full_text": "å„ä½è§‚ä¼—å¤§å®¶å¥½...",
    "segments": [...]
  },
  "quality_scores": {
    "narrative_coherence": 0.92,
    "audio_video_sync": 0.88,
    "content_coverage": 0.85,
    "production_quality": 0.90,
    "engagement_potential": 0.87,
    "overall_score": 0.88
  },
  "statistics": {
    "total_clips": 8,
    "source_videos": 2,
    "total_duration": 62.5,
    "narration_duration": 58.3,
    "processing_time": 245.6
  }
}
```

**ä¸å…¶ä»–æµç¨‹å¯¹æ¯”**:

| ç‰¹æ€§ | æµç¨‹1 (åŸºç¡€æ‰¹å¤„ç†) | æµç¨‹2 (è§†é¢‘ç”Ÿäº§) | æµç¨‹2.5 (å®Œæ•´é›†æˆ) |
|------|-------------------|-----------------|-------------------|
| å¤šè§†é¢‘è¾“å…¥ | âœ… | âŒ | âœ… |
| AIè§†é¢‘åˆ†æ | âœ… | âŒ | âœ… |
| æ™ºèƒ½å‰ªè¾‘ | âœ… | âŒ | âœ… |
| è„šæœ¬ç”Ÿæˆ | âŒ | âœ… | âœ… |
| TTSè¯­éŸ³ | âŒ | âœ… | âœ… |
| éŸ³è§†é¢‘åˆæˆ | âŒ | âœ… | âœ… |
| å®Œå…¨è‡ªåŠ¨åŒ– | éƒ¨åˆ† | éœ€è¦æ‰‹åŠ¨ | âœ… å…¨è‡ªåŠ¨ |
| ä½¿ç”¨åœºæ™¯ | å¿«é€Ÿå‰ªè¾‘ | æœ‰è„šæœ¬åˆ¶ä½œ | ä¸€é”®æˆç‰‡ |

**é€‚ç”¨åœºæ™¯**:
- ğŸ“¹ **è‡ªåª’ä½“åˆ›ä½œ**: å¤šä¸ªåŸå§‹ç´ æä¸€é”®ç”Ÿæˆæˆå“è§†é¢‘
- ğŸ“š **æ•™è‚²åŸ¹è®­**: è¯¾ç¨‹ç´ æè‡ªåŠ¨ç”Ÿæˆå¸¦è®²è§£çš„æ•™å­¦è§†é¢‘
- ğŸ“° **æ–°é—»å¿«è®¯**: æ–°é—»ç‰‡æ®µè‡ªåŠ¨ç”Ÿæˆè§£è¯´è§†é¢‘
- ğŸ¬ **Vlogåˆ¶ä½œ**: æ—…è¡Œ/ç”Ÿæ´»ç´ æè‡ªåŠ¨ç”Ÿæˆæ•…äº‹åŒ–è§†é¢‘
- ğŸ¯ **è¥é”€æ¨å¹¿**: äº§å“ç´ æè‡ªåŠ¨ç”Ÿæˆå®£ä¼ è§†é¢‘

---

### æµç¨‹ 3: é«˜çº§è§†é¢‘æ··å‰ªæµç¨‹ (æ–°å¢)

**å…¥å£**: `AdvancedVideoMixingService`

```
è¾“å…¥: è§†é¢‘åˆ—è¡¨ + ç‰‡æ®µå®šä¹‰
   â†“
[1. å¹¶è¡Œæå–ç‰‡æ®µ] extract_clips_parallel()
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ThreadPoolExecutor (4 workers) â”‚
   â”‚  â€¢ ç‰‡æ®µ1 â†’ extract_video_clip  â”‚
   â”‚  â€¢ ç‰‡æ®µ2 â†’ extract_video_clip  â”‚
   â”‚  â€¢ ç‰‡æ®µN â†’ extract_video_clip  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“ (æ€§èƒ½æå‡4x)
[2. åº”ç”¨æ»¤é•œ] (å¯é€‰)
   â€¢ äº®åº¦/å¯¹æ¯”åº¦
   â€¢ ç°åº¦/å¤å¤
   â€¢ æ¨¡ç³Š/é”åŒ–
   â†“
[3. åº”ç”¨è½¬åœºæ•ˆæœ]
   â€¢ æ·¡å…¥æ·¡å‡º
   â€¢ æ»‘åŠ¨/ç¼©æ”¾
   â€¢ äº¤å‰æ·¡åŒ–
   â†“
[4. å¸ƒå±€åˆæˆ]
   â€¢ å•è§†é¢‘æ‹¼æ¥
   â€¢ ç”»ä¸­ç”»
   â€¢ åˆ†å±/ç½‘æ ¼
   â†“
[5. è¾“å‡ºæ¸²æŸ“]
   â€¢ è´¨é‡é…ç½®
   â€¢ ç¼–ç è¾“å‡º
   â†“
è¾“å‡º: é«˜è´¨é‡æ··å‰ªè§†é¢‘
```

**ç‰¹ç‚¹**:
- âš¡ 4xæ€§èƒ½ä¼˜åŒ–
- ğŸ¬ 6ç§ä¸“ä¸šè½¬åœº
- ğŸ“ 5ç§å¸ƒå±€æ¨¡å¼
- ğŸ¨ 7ç§è§†é¢‘æ»¤é•œ

---

### æµç¨‹ 4: æ™ºèƒ½å‰ªè¾‘ç­–ç•¥ä¼˜åŒ–

**å…¥å£**: `SmartClipStrategy`

```
è¾“å…¥: åŸå§‹ç‰‡æ®µåˆ—è¡¨
   â†“
[1. æƒ…æ„Ÿåˆ†æ] analyze_clip_emotion()
   â€¢ è¯†åˆ«æ­£é¢/è´Ÿé¢/ä¸­æ€§
   â€¢ å…³é”®è¯åŒ¹é…
   â†“
[2. å†…å®¹åˆ†ç±»] classify_content_type()
   â€¢ åŠ¨ä½œ/å¯¹è¯/é£æ™¯
   â€¢ ç‰¹å†™/è¿‡æ¸¡
   â†“
[3. è´¨é‡è¯„ä¼°] calculate_clip_metrics()
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â€¢ è§†è§‰è´¨é‡ (ä¼˜å…ˆçº§)          â”‚
   â”‚ â€¢ éŸ³é¢‘è´¨é‡ (æ—¶é•¿)            â”‚
   â”‚ â€¢ å†…å®¹ä¸°å¯Œåº¦ (æè¿°)          â”‚
   â”‚ â€¢ æƒ…æ„Ÿå½±å“åŠ› (æƒ…æ„Ÿåˆ†æ•°)      â”‚
   â”‚ â†’ ç»¼åˆè¯„åˆ† (åŠ æƒå¹³å‡)        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
[4. å»é‡ä¼˜åŒ–] remove_duplicate_clips()
   â€¢ æ—¶é—´é‡å æ£€æµ‹
   â€¢ 5ç§’é˜ˆå€¼å»é‡
   â†“
[5. æ—¶é•¿ä¼˜åŒ–] optimize_clip_duration()
   â€¢ è£å‰ªè¿‡é•¿ç‰‡æ®µ
   â€¢ æ‰©å±•è¿‡çŸ­ç‰‡æ®µ
   â€¢ ç¬¦åˆç›®æ ‡æ—¶é•¿
   â†“
[6. æ™ºèƒ½æ’åº] sort_clips_by_narrative()
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å™äº‹é£æ ¼:                    â”‚
   â”‚ â€¢ crescendo (æ¸å¼ºå¼)         â”‚
   â”‚ â€¢ decrescendo (æ¸å¼±å¼)       â”‚
   â”‚ â€¢ wave (æ³¢æµªå¼)              â”‚
   â”‚ â€¢ chronological (æ—¶é—´é¡ºåº)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
è¾“å‡º: ä¼˜åŒ–åçš„ç‰‡æ®µæ–¹æ¡ˆ
```

**åˆ›æ–°ç‚¹**:
- ğŸ§  AIé©±åŠ¨çš„æƒ…æ„Ÿåˆ†æ
- ğŸ“Š å¤šç»´åº¦è´¨é‡è¯„ä¼°
- ğŸ¯ 4ç§å™äº‹é£æ ¼
- ğŸ” æ™ºèƒ½å»é‡å’Œä¼˜åŒ–

---

## è¯¦ç»†æŠ€æœ¯æµç¨‹

### é˜¶æ®µ1: è§†é¢‘å‡†å¤‡ (prepare_video_task)

```python
# æ–‡ä»¶: app/workers/batch_processing_tasks.py

è¾“å…¥: VideoSource (æœ¬åœ°/OSS/URL)
   â†“
[ä¸‹è½½/éªŒè¯]
   â€¢ æœ¬åœ°æ–‡ä»¶: éªŒè¯å­˜åœ¨æ€§
   â€¢ è¿œç¨‹æ–‡ä»¶: å¼‚æ­¥ä¸‹è½½
   â†“
[æ—¶é•¿éªŒè¯]
   â€¢ è·å–è§†é¢‘å…ƒæ•°æ®
   â€¢ æ£€æŸ¥æ—¶é•¿é™åˆ¶ (MAX_VIDEO_DURATION)
   â†“
è¾“å‡º: {
  video_index: int,
  local_path: str,
  source: VideoSource,
  error: Optional[str]
}
```

**å…³é”®ä»£ç ä½ç½®**: `batch_processing_tasks.py:298`

---

### é˜¶æ®µ2: å‹ç¼©ä¸Šä¼  (compress_and_upload_task)

```python
è¾“å…¥: prepared_video
   â†“
[è·å–åŸå§‹å…ƒä¿¡æ¯]
   â€¢ æ—¶é•¿ã€åˆ†è¾¨ç‡ã€ç ç‡
   â†“
[è§†é¢‘å‹ç¼©]
   â€¢ ä½¿ç”¨å‹ç¼©é…ç½®
   â€¢ VideoCompressionService
   â€¢ ç›®æ ‡: é™ä½tokenæˆæœ¬
   â†“
[ä¸Šä¼ ä¸´æ—¶å­˜å‚¨]
   â€¢ TempStorageService
   â€¢ OSS/æœ¬åœ°å­˜å‚¨
   â€¢ è®¾ç½®è¿‡æœŸæ—¶é—´
   â†“
è¾“å‡º: {
  video_index: int,
  compressed_path: str,
  oss_url: str,
  compression_stats: dict,
  status: 'compressed'
}
```

**å…³é”®ä»£ç ä½ç½®**: `batch_processing_tasks.py:371`

**å‹ç¼©é…ç½®**:
```python
compression_profiles = {
    'aggressive': {
        'target_bitrate': '500k',
        'max_resolution': (720, 1280)
    },
    'balanced': {
        'target_bitrate': '1000k',
        'max_resolution': (1080, 1920)
    },
    'quality': {
        'target_bitrate': '2000k',
        'max_resolution': (1080, 1920)
    }
}
```

---

### é˜¶æ®µ3: AIè§†é¢‘åˆ†æ (analyze_video_task)

```python
è¾“å…¥: compressed_video + vl_model
   â†“
[æ„å»ºåˆ†ææç¤º]
   â€¢ è§†é¢‘ä¸»é¢˜å’Œæ ¸å¿ƒå†…å®¹
   â€¢ å…³é”®åœºæ™¯å’Œé‡è¦æ—¶åˆ»
   â€¢ è§†è§‰é£æ ¼å’Œç”»é¢è´¨é‡
   â€¢ é€‚åˆå‰ªè¾‘çš„ç²¾å½©ç‰‡æ®µ
   â†“
[è°ƒç”¨DashScope VLæ¨¡å‹]
   â€¢ Model: qwen-vl-plus / qwen-vl-max
   â€¢ è¾“å…¥: è§†é¢‘URL
   â€¢ è¾“å‡º: ç»“æ„åŒ–åˆ†æ
   â†“
[æå–å…³é”®æ—¶åˆ»]
   â€¢ æ—¶é—´æˆ³è§£æ (HH:MM:SS, MM:SS, ç§’)
   â€¢ å…³é”®è¯ç½®ä¿¡åº¦è¯„åˆ†
   â€¢ 5ç§’çª—å£å»é‡
   â†“
è¾“å‡º: {
  video_index: int,
  vl_analysis: dict,
  analysis_summary: str,
  key_moments: [{timestamp, description, confidence}],
  status: 'analyzed'
}
```

**å…³é”®ä»£ç ä½ç½®**: `batch_processing_tasks.py:459`

**æ—¶é—´æˆ³æå–**:
- æ”¯æŒæ ¼å¼: `HH:MM:SS`, `MM:SS`, `90ç§’`, `90s`
- ç½®ä¿¡åº¦ç®—æ³•: åŸºç¡€0.5 + å…³é”®è¯0.3 + æè¿°é•¿åº¦0.2

---

### é˜¶æ®µ4: ç”Ÿæˆå‰ªè¾‘æ–¹æ¡ˆ (generate_clip_plan_task)

```python
è¾“å…¥: analysis_results[] + text_model + strategy
   â†“
[èšåˆåˆ†æç»“æœ]
   â€¢ è¿‡æ»¤å¤±è´¥çš„åˆ†æ
   â€¢ æå–å…³é”®ä¿¡æ¯
   â€¢ æ„å»ºä¸Šä¸‹æ–‡
   â†“
[æ„å»ºæç¤ºè¯]
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ç³»ç»Ÿæç¤º:                       â”‚
   â”‚ â€¢ å‰ªè¾‘ç­–ç•¥ (highlights/story)   â”‚
   â”‚ â€¢ ç›®æ ‡æ—¶é•¿                      â”‚
   â”‚ â€¢ ç‰‡æ®µé€‰æ‹©æ ‡å‡†                  â”‚
   â”‚ â€¢ JSONè¾“å‡ºæ ¼å¼                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
[è°ƒç”¨LLMç”Ÿæˆæ–¹æ¡ˆ]
   â€¢ Model: qwen-plus / qwen-turbo
   â€¢ è¾“å…¥: èšåˆä¸Šä¸‹æ–‡ + æç¤º
   â€¢ è¾“å‡º: JSONå‰ªè¾‘æ–¹æ¡ˆ
   â†“
[è§£æå’ŒéªŒè¯]
   â€¢ JSONæå– (Markdown/æ‹¬å·åŒ¹é…)
   â€¢ Pydanticæ¨¡å‹éªŒè¯
   â€¢ è‡ªåŠ¨ä¿®å¤å¸¸è§é”™è¯¯
   â†“
[è´¨é‡è¯„åˆ†]
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 5ç»´åº¦è¯„åˆ†:                      â”‚
   â”‚ â€¢ è§†é¢‘è¦†ç›–ç‡ (30%)               â”‚
   â”‚ â€¢ æ—¶é•¿ç¬¦åˆåº¦ (25%)               â”‚
   â”‚ â€¢ ç‰‡æ®µå¤šæ ·æ€§ (20%)               â”‚
   â”‚ â€¢ ä¼˜å…ˆçº§è´¨é‡ (15%)               â”‚
   â”‚ â€¢ AIåˆ†æè´¨é‡ (10%)               â”‚
   â”‚ â†’ æ€»åˆ† (0.0-1.0)                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
è¾“å‡º: {
  strategy: str,
  total_duration: float,
  segments: [ClipSegment],
  reasoning: str,
  quality_score: float
}
```

**å…³é”®ä»£ç ä½ç½®**: `batch_processing_tasks.py:538`

**JSONè§£æç­–ç•¥**:
1. Markdownä»£ç å—æå–
2. æ‹¬å·åŒ¹é…æå–
3. è‡ªåŠ¨ä¿®å¤ (æ³¨é‡Š/å•å¼•å·/å°¾éšé€—å·)
4. PydanticéªŒè¯
5. è¯¦ç»†é”™è¯¯æ—¥å¿—

---

### é˜¶æ®µ5: æ‰§è¡Œå‰ªè¾‘ (execute_clip_plan_task)

```python
è¾“å…¥: clip_plan + video_paths + quality
   â†“
[è½¬æ¢ç‰‡æ®µæ ¼å¼]
   â€¢ Dict â†’ ClipSegmentå¯¹è±¡
   â€¢ æŒ‰ä¼˜å…ˆçº§æ’åº
   â†“
[å¹¶è¡Œæå–ç‰‡æ®µ] (å¯é€‰)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ThreadPoolExecutor              â”‚
   â”‚  ç‰‡æ®µ1 â†’ extract_clip           â”‚
   â”‚  ç‰‡æ®µ2 â†’ extract_clip           â”‚
   â”‚  ç‰‡æ®µN â†’ extract_clip           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
[åº”ç”¨è½¬åœºå’Œç‰¹æ•ˆ] (å¯é€‰)
   â€¢ æ·¡å…¥æ·¡å‡º
   â€¢ æ»‘åŠ¨/ç¼©æ”¾
   â€¢ è§†é¢‘æ»¤é•œ
   â†“
[æ‹¼æ¥è§†é¢‘]
   â€¢ MoviePy concatenate_videoclips
   â€¢ éŸ³è§†é¢‘åŒæ­¥
   â€¢ è´¨é‡é…ç½®
   â†“
[ä¸Šä¼ æœ€ç»ˆè§†é¢‘]
   â€¢ æœ¬åœ°è·¯å¾„
   â€¢ OSS URL (å¦‚å¯ç”¨)
   â†“
è¾“å‡º: {
  final_video_path: str,
  final_video_url: str,
  duration: float,
  file_size: int,
  processing_stats: dict
}
```

**å…³é”®ä»£ç ä½ç½®**: `batch_processing_tasks.py:675`

---

## æœåŠ¡æ¨¡å—è¯´æ˜

### è§†é¢‘å¤„ç†æœåŠ¡

| æœåŠ¡ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **VideoEditingService** | `video_editing.py` | è§†é¢‘å‰ªè¾‘ã€æ‹¼æ¥ã€è½¬åœº |
| **AdvancedVideoMixingService** | `advanced_video_mixing.py` | é«˜çº§æ··å‰ªã€å¹¶è¡Œå¤„ç†ã€å¸ƒå±€ |
| **VideoCompressionService** | `video_compression.py` | è§†é¢‘å‹ç¼©ã€å…ƒæ•°æ®æå– |
| **VideoAudioComposer** | `video_audio_composer.py` | éŸ³è§†é¢‘åˆæˆã€æ—¶é—´è½´å¯¹é½ |
| **AudioExtractor** | `audio_extractor.py` | éŸ³é¢‘æå–ã€è¯­éŸ³è¯†åˆ« |

### AIæœåŠ¡

| æœåŠ¡ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **DashScopeClient** | `utils/ai_clients/dashscope_client.py` | ç»Ÿä¸€AIè°ƒç”¨æ¥å£ |
| **ScriptGenerationService** | `script_generation.py` | è„šæœ¬ç”Ÿæˆ |
| **SmartClipStrategy** | `smart_clip_strategy.py` | æ™ºèƒ½å‰ªè¾‘ç­–ç•¥ |

### å­˜å‚¨æœåŠ¡

| æœåŠ¡ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **TempStorageService** | `temp_storage.py` | ä¸´æ—¶æ–‡ä»¶ç®¡ç†ã€OSSä¸Šä¼  |
| **StorageAdapter** | `adapters/storage_adapter.py` | ç»Ÿä¸€å­˜å‚¨æ¥å£ |

### ç¼–æ’æœåŠ¡

| æœåŠ¡ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **VideoProductionOrchestrator** | `video_production_orchestrator.py` | å®Œæ•´è§†é¢‘ç”Ÿäº§æµç¨‹ |
| **VideoAnalysisOrchestrator** | `video_analysis_orchestrator.py` | è§†é¢‘åˆ†æç¼–æ’ |

---

## æ•°æ®æµè½¬

### æ ¸å¿ƒæ•°æ®æ¨¡å‹

#### VideoSource
```python
class VideoSource(BaseModel):
    type: VideoSourceType  # LOCAL/OSS/URL
    path: Optional[str]    # æœ¬åœ°è·¯å¾„
    url: Optional[str]     # è¿œç¨‹URL
    metadata: Dict = {}
```

#### VideoAnalysisResult
```python
class VideoAnalysisResult(BaseModel):
    video_index: int
    duration: float
    vl_analysis: Dict
    analysis_summary: str
    key_moments: List[Dict]
    status: str
```

#### ClipSegment
```python
class ClipSegment(BaseModel):
    video_index: int       # æºè§†é¢‘ç´¢å¼•
    start_time: float      # å¼€å§‹æ—¶é—´ï¼ˆç§’ï¼‰
    end_time: float        # ç»“æŸæ—¶é—´ï¼ˆç§’ï¼‰
    priority: int          # ä¼˜å…ˆçº§ 1-10
    reason: str            # é€‰æ‹©ç†ç”±

    @property
    def duration(self) -> float:
        return self.end_time - self.start_time
```

#### ClipPlan
```python
class ClipPlan(BaseModel):
    strategy: str
    total_duration: float
    segments: List[ClipSegment]
    reasoning: str
    quality_score: float
```

### æ•°æ®æµè½¬ç¤ºæ„å›¾

```
VideoSource
   â†“ (prepare)
LocalPath + Metadata
   â†“ (compress)
CompressedPath + OSSUrl
   â†“ (analyze)
VideoAnalysisResult
   â†“ (aggregate)
AnalysisResults[]
   â†“ (generate)
ClipPlan
   â†“ (execute)
FinalVideo + Stats
```

---

## é”™è¯¯å¤„ç†ä¸é‡è¯•

### Celeryä»»åŠ¡é…ç½®

```python
@celery_app.task(
    bind=True,
    max_retries=3,              # æœ€å¤§é‡è¯•3æ¬¡
    default_retry_delay=60,     # 60ç§’åé‡è¯•
    autoretry_for=(Exception,), # è‡ªåŠ¨é‡è¯•çš„å¼‚å¸¸
    retry_backoff=True,         # æŒ‡æ•°é€€é¿
    retry_jitter=True           # æ·»åŠ éšæœºæŠ–åŠ¨
)
```

### é˜Ÿåˆ—éš”ç¦»

```python
# é˜Ÿåˆ—é…ç½®
CELERY_TASK_ROUTES = {
    'batch_processing.analyze_video': {'queue': 'analyzer'},
    'batch_processing.execute_clip_plan': {'queue': 'clipper'},
    '*': {'queue': 'default'}
}
```

**ç›®çš„**: é˜²æ­¢åˆ†æä»»åŠ¡é˜»å¡å‰ªè¾‘ä»»åŠ¡

### é”™è¯¯ä¼ é€’æœºåˆ¶

```python
# æ¯ä¸ªä»»åŠ¡è¿”å›åŒ…å«errorå­—æ®µ
{
    'video_index': 0,
    'status': 'failed',
    'error': 'è¯¦ç»†é”™è¯¯ä¿¡æ¯',
    ...
}

# åç»­ä»»åŠ¡æ£€æŸ¥errorå­—æ®µ
if task_result.get('error'):
    logger.error(f"ä¸Šæ¸¸ä»»åŠ¡å¤±è´¥: {task_result['error']}")
    # ç»§ç»­å¤„ç†æˆ–æå‰è¿”å›
```

### å¸¸è§é”™è¯¯åœºæ™¯

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | é‡è¯•æ¬¡æ•° |
|---------|---------|---------|
| ç½‘ç»œè¶…æ—¶ | è‡ªåŠ¨é‡è¯• + æŒ‡æ•°é€€é¿ | 3æ¬¡ |
| è§†é¢‘æŸå | è·³è¿‡è¯¥è§†é¢‘ + è®°å½•æ—¥å¿— | 0æ¬¡ |
| AIè°ƒç”¨å¤±è´¥ | é‡è¯• + é™çº§ç­–ç•¥ | 3æ¬¡ |
| å­˜å‚¨ç©ºé—´ä¸è¶³ | æ¸…ç†ä¸´æ—¶æ–‡ä»¶ + é‡è¯• | 1æ¬¡ |
| è§£æJSONå¤±è´¥ | å¤šç­–ç•¥è§£æ + äººå·¥å®¡æ ¸ | 0æ¬¡ |

---

## æ€§èƒ½ä¼˜åŒ–æ€»ç»“

### å¹¶è¡Œå¤„ç†

| é˜¶æ®µ | å¹¶è¡Œç­–ç•¥ | æ€§èƒ½æå‡ |
|------|---------|---------|
| è§†é¢‘å‡†å¤‡ | Celery group | Nä¸ªè§†é¢‘åŒæ—¶å¤„ç† |
| å‹ç¼©ä¸Šä¼  | é“¾å¼è°ƒç”¨ | æµæ°´çº¿å¤„ç† |
| AIåˆ†æ | Celery group | Nä¸ªè§†é¢‘åŒæ—¶åˆ†æ |
| ç‰‡æ®µæå– | ThreadPoolExecutor | 4xæå‡ |

### ç¼“å­˜ç­–ç•¥

```python
# Redisç¼“å­˜
- ä»»åŠ¡çŠ¶æ€: task:{task_id}
- åˆ†æç»“æœ: analysis:{video_id}
- å‰ªè¾‘æ–¹æ¡ˆ: clip_plan:{task_id}

# æœ¬åœ°ç¼“å­˜
- å‹ç¼©è§†é¢‘: storage/compressed/
- ä¸´æ—¶ç‰‡æ®µ: storage/temp/
- æœ€ç»ˆè¾“å‡º: storage/processed/
```

### èµ„æºç®¡ç†

```python
# è‡ªåŠ¨æ¸…ç†
- ä¸´æ—¶æ–‡ä»¶: 24å°æ—¶ååˆ é™¤
- OSSä¸´æ—¶å­˜å‚¨: å¯é…ç½®è¿‡æœŸæ—¶é—´
- å‹ç¼©è§†é¢‘: å¤„ç†å®Œæˆååˆ é™¤

# é™æµ
- å¹¶å‘ä»»åŠ¡æ•°: å¯é…ç½®
- APIé€Ÿç‡é™åˆ¶: DashScopeé…é¢
- å­˜å‚¨ç©ºé—´ç›‘æ§: è‡ªåŠ¨æ¸…ç†
```

---

## ç›‘æ§ä¸è°ƒè¯•

### æ—¥å¿—ç³»ç»Ÿ

```python
# æ—¥å¿—çº§åˆ«
- INFO: å…³é”®æµç¨‹èŠ‚ç‚¹
- DEBUG: è¯¦ç»†å¤„ç†ä¿¡æ¯
- WARNING: å¼‚å¸¸ä½†å¯å¤„ç†çš„æƒ…å†µ
- ERROR: é”™è¯¯å’Œå¼‚å¸¸å †æ ˆ

# æ—¥å¿—ä¸Šä¸‹æ–‡
logger.info(
    "ä»»åŠ¡è¿›åº¦",
    task_id=task_id,
    video_index=idx,
    stage="analyzing"
)
```

### Celeryç›‘æ§

```bash
# Flowerç›‘æ§ç•Œé¢
http://localhost:5555

# æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
celery -A app.workers.celery_app inspect active
celery -A app.workers.celery_app inspect stats

# æ¸…ç©ºé˜Ÿåˆ—
celery -A app.workers.celery_app purge
```

### APIå¥åº·æ£€æŸ¥

```bash
# æ‰¹å¤„ç†æœåŠ¡å¥åº·æ£€æŸ¥
GET /api/v1/batch/health

# å“åº”
{
  "status": "healthy",
  "celery_connected": true,
  "workers_active": 2
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´æ‰¹å¤„ç†è¯·æ±‚

```python
import requests

# åˆ›å»ºæ‰¹å¤„ç†ä»»åŠ¡
response = requests.post(
    "http://localhost:8000/api/v1/batch/process",
    json={
        "videos": [
            {
                "type": "LOCAL",
                "path": "/path/to/video1.mp4"
            },
            {
                "type": "URL",
                "url": "https://example.com/video2.mp4"
            }
        ],
        "clip_strategy": "highlights",
        "target_duration": 60.0,
        "output_quality": "high",
        "vl_model": "qwen-vl-plus",
        "text_model": "qwen-plus"
    }
)

task_id = response.json()["task_id"]

# æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
status_response = requests.get(
    f"http://localhost:8000/api/v1/batch/tasks/{task_id}/status"
)

# è·å–æœ€ç»ˆç»“æœ
result_response = requests.get(
    f"http://localhost:8000/api/v1/batch/tasks/{task_id}/result"
)
```

### é«˜çº§æ··å‰ª

```python
from app.services.advanced_video_mixing import advanced_video_mixing_service
from app.models.batch_processing import ClipSegment

# å®šä¹‰ç‰‡æ®µ
segments = [
    ClipSegment(
        video_index=0,
        start_time=0.0,
        end_time=5.0,
        priority=5,
        reason="ç²¾å½©å¼€åœº"
    ),
    ClipSegment(
        video_index=1,
        start_time=10.0,
        end_time=15.0,
        priority=4,
        reason="é«˜æ½®æ—¶åˆ»"
    ),
]

# æ‰§è¡Œæ··å‰ª
output_path, stats = await advanced_video_mixing_service.mix_videos_advanced(
    video_paths=["video1.mp4", "video2.mp4"],
    segments=segments,
    output_path="output.mp4",
    transition_type="crossfade",
    apply_filters={"brightness": 0.7},
    enable_parallel=True
)
```

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆéœ€è¦å‹ç¼©è§†é¢‘ï¼Ÿ
**A**: é™ä½AIè°ƒç”¨tokenæˆæœ¬ã€‚åŸå§‹4Kè§†é¢‘å¯èƒ½æ¶ˆè€—å¤§é‡tokenï¼Œå‹ç¼©åˆ°720på¯ä»¥èŠ‚çœ60-80%çš„æˆæœ¬ã€‚

### Q: ä»»åŠ¡å¡åœ¨PENDINGçŠ¶æ€æ€ä¹ˆåŠï¼Ÿ
**A**: æ£€æŸ¥Celery Workeræ˜¯å¦è¿è¡Œï¼ŒæŸ¥çœ‹Redisè¿æ¥ï¼ŒæŸ¥çœ‹Workeræ—¥å¿—ã€‚

### Q: å¦‚ä½•æé«˜å¤„ç†é€Ÿåº¦ï¼Ÿ
**A**:
1. å¢åŠ Workeræ•°é‡
2. å¯ç”¨å¹¶è¡Œå¤„ç† (`enable_parallel=True`)
3. ä½¿ç”¨æ›´å¿«çš„å‹ç¼©é…ç½®
4. å‡å°‘ä¸å¿…è¦çš„åˆ†æ

### Q: æ”¯æŒå“ªäº›è§†é¢‘æ ¼å¼ï¼Ÿ
**A**: MoviePyæ”¯æŒçš„æ‰€æœ‰æ ¼å¼ï¼ˆmp4, avi, mov, mkvç­‰ï¼‰ï¼Œæ¨èä½¿ç”¨mp4ã€‚

### Q: å¦‚ä½•è‡ªå®šä¹‰å‰ªè¾‘ç­–ç•¥ï¼Ÿ
**A**: ä¿®æ”¹ `generate_clip_plan_task` ä¸­çš„æç¤ºè¯ï¼Œæˆ–ä½¿ç”¨ `SmartClipStrategy` è‡ªå®šä¹‰æ’åºé€»è¾‘ã€‚

---

## ç›¸å…³æ–‡æ¡£

- [é«˜çº§è§†é¢‘æ··å‰ªæ–‡æ¡£](./ADVANCED_VIDEO_MIXING.md)
- [é¡¹ç›®ä¸»æ–‡æ¡£](../CLAUDE.md)
- [APIæ–‡æ¡£](http://localhost:8000/api/v1/docs)

---

**æœ€åæ›´æ–°**: 2025-01-06
**ç‰ˆæœ¬**: v1.0.0
